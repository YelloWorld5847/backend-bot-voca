<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Bot Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-6">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-blue-400">üöÄ Vocal Dashboard</h1>

        <!-- Cartes Globales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-gray-400 text-sm font-semibold uppercase">Total Vues G√©n√©r√©es</h3>
                <p class="text-4xl font-bold text-white mt-2" id="stat-views">...</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-gray-400 text-sm font-semibold uppercase">Bande Passante (Succ√®s)</h3>
                <p class="text-4xl font-bold text-blue-400 mt-2" id="stat-data">...</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-gray-400 text-sm font-semibold uppercase">Comptes Actifs</h3>
                <p class="text-4xl font-bold text-purple-400 mt-2" id="stat-users">...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Graphique d'activit√© r√©cente -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 lg:col-span-2">
                <h3 class="text-lg font-bold mb-4">Activit√© R√©cente (Derni√®res vues)</h3>
                <canvas id="activityChart" height="100"></canvas>
            </div>

            <!-- Tableau des Cr√©dits Restants -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 overflow-hidden">
                <h3 class="text-lg font-bold mb-4">Soldes (Mo Restants)</h3>
                <div class="overflow-y-auto max-h-80 pr-2">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-sm border-b border-gray-700">
                                <th class="pb-2">Utilisateur</th>
                                <th class="pb-2 text-right">Cr√©dits</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- tableau D√©taill√© par Vues & Articles -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700 overflow-hidden mb-12">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-blue-300">üìä D√©tail des Vues par Utilisateur & Article</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left whitespace-nowrap">
                    <thead>
                        <tr class="text-gray-400 text-sm border-b border-gray-700">
                            <th class="pb-3 px-4">Utilisateur</th>
                            <th class="pb-3 px-4">Article</th>
                            <th class="pb-3 px-4 text-right">Vues Valid√©es</th>
                            <th class="pb-3 px-4 text-right">Data Utilis√©e</th>
                        </tr>
                    </thead>
                    <tbody id="articles-table">
                        <!-- Rempli par JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        async function loadDashboard() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();

                // mise √† jour des cartes globales (avec les vrais chiffres de la DB)
                document.getElementById('stat-views').innerText = data.global.allTimeViews.toLocaleString('fr-FR');
                document.getElementById('stat-data').innerText = (data.global.allTimeMb / 1024).toFixed(2) + ' Go';
                document.getElementById('stat-users').innerText = data.users.length;

                // remplissage du tableau des soldes utilisateurs
                const tbodyUsers = document.getElementById('users-table');
                data.users.forEach(u => {
                    const isLow = u.remaining_mb < 50;
                    tbodyUsers.innerHTML += `
                        <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                            <td class="py-3 font-medium">${u.username}</td>
                            <td class="py-3 text-right font-bold ${isLow ? 'text-red-400' : 'text-green-400'}">
                                ${u.remaining_mb.toFixed(1)} Mo
                            </td>
                        </tr>
                    `;
                });

                // remplissage du tableau d√©taill√© Vues / Article
                const tbodyArticles = document.getElementById('articles-table');
                data.articleStats.forEach(stat => {
                    // Raccourcir l'URL visuellement pour que le tableau reste propre
                    const shortUrl = stat.article_url.length > 60 
                        ? stat.article_url.substring(0, 60) + '...' 
                        : stat.article_url;

                    tbodyArticles.innerHTML += `
                        <tr class="border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors">
                            <td class="py-3 px-4 font-bold text-purple-300">@${stat.username}</td>
                            <td class="py-3 px-4 text-gray-300">
                                <a href="${stat.article_url}" target="_blank" class="hover:text-blue-400 hover:underline">
                                    ${shortUrl}
                                </a>
                            </td>
                            <td class="py-3 px-4 text-right font-bold text-green-400 text-lg">${stat.total_views.toLocaleString('fr-FR')}</td>
                            <td class="py-3 px-4 text-right text-gray-400">${stat.total_mb.toFixed(1)} Mo</td>
                        </tr>
                    `;
                });

                // pr√©paration des donn√©es pour le Graphique Chart.js (bas√© sur l'activit√© r√©cente)
                const countsByHour = {};
                data.recentLogs.forEach(log => {
                    const date = new Date(log.created_at);
                    const key = date.toISOString().slice(0, 13) + ':00'; // Grouper par heure
                    countsByHour[key] = (countsByHour[key] || 0) + 1;
                });

                const sortedKeys = Object.keys(countsByHour).sort();
                const labels = sortedKeys.map(k => new Date(k).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                const chartData = sortedKeys.map(k => countsByHour[k]);

                // Affichage du graphiqu
                const ctx = document.getElementById('activityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets:[{
                            label: 'Vues g√©n√©r√©es',
                            data: chartData,
                            borderColor: '#60A5FA', 
                            backgroundColor: 'rgba(96, 165, 250, 0.2)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#374151' } },
                            x: { grid: { display: false } }
                        }
                    }
                });

            } catch (err) {
                console.error("Erreur chargement dashboard :", err);
            }
        }

        loadDashboard();
    </script>
</body>
</html>